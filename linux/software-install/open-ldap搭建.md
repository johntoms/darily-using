# LDAP 学习总结
> `LDAP` 是轻量目录访问协议，英文全称是`Lightweight Directory Access Protocol`，一般都简称为`LDAP`。它是基于`X.500`标准的，但是简单多了并且可以根据需要定制。与`X.500`不同，`LDAP`支持`TCP/IP`，这对访问`Internet`是必须的。`LDAP`的核心规范在`RFC`中都有定义，所有与`LDAP`相关的RFC都可以在LDAPman RFC网页中找到。简单说来，`LDAP`是一个得到关于人或者资源的集中、静态数据的快速方式。 `LDAP`是一个用来发布目录信息到许多不同资源的协议。通常它都作为一个集中的地址本使用，不过根据组织者的需要，它可以做得更加强大。
[TOC]

## 什么是 `LDAP`？

- LDAP（Light Directory Access Portocol），它是基于X.500标准的轻量级目录访问协议。
- 目录是一个为查询、浏览和搜索而优化的数据库，它成树状结构组织数据，类似文件目录一样。
- 目录数据库和关系数据库不同，它有优异的读性能，但写性能差，并且没有事务处理、回滚等复杂功能，不适于存储修改频繁的数据。所以目录天生是用来查询的，就好象它的名字一样。
- LDAP目录服务是由目录数据库和一套访问协议组成的系统。
- 目录服务是一个特殊的数据库，用来保存描述性的、基于属性的详细信息，支持过滤功能。



## 为什么要用 `LDAP`?

先来看看以下几个问题：

1. 我们日常的办公系统是不是有多个？
2. 每个系统之间是不是都有独立的账号密码？
3. 密码多了，有时候半天想不起来哪个密码对应哪个系统？
4. 每次新项目的开发，都需要重新开发和维护一套用户密码？
5. 维护多套系统的用户是不是非常头疼？

解决方法：

- LDAP统一认证服务
- LDAP是开放的Internet标准，支持跨平台的Internet协议，在业界中得到广泛认可的，并且市场上或者开源社区上的大多产品都加入了对LDAP的支持，因此对于这类系统，不需单独定制，只需要通过LDAP做简单的配置就可以与服务器做认证交互。



## `LDAP`基本概念

LDAP是轻量目录访问协议，英文全称是Lightweight Directory Access Protocol，一般都简称为LDAP。它是基于X.500标准的，但是简单多了并且可以根据需要定制。与X.500不同，LDAP支持TCP/IP，这对访问Internet是必须的。LDAP的核心规范在RFC中都有定义，所有与LDAP相关的RFC都可以在LDAPman RFC网页中找到。简单说来，LDAP是一个得到关于人或者资源的集中、静态数据的快速方式。 LDAP是一个用来发布目录信息到许多不同资源的协议。通常它都作为一个集中的地址本使用，不过根据组织者的需要，它可以做得更加强大。

现在市场上有关LDAP的产品已有很多，各大软件公司都在他们的产品中集成了LDAP服务，如Microsoft的ActiveDirectory、Lotus的Domino Directory、IBM的WebSphere中也集成了LDAP服务。**LDAP的开源实现是OpenLDAP**，它比商业产品一点也不差，而且源码开放。

OpenLDAP 是最常用的目录服务之一，它是一个由开源社区及志愿者开发和管理的一个开源项目，提供了目录服务的所有功能，包括目录搜索、身份认证、安全通道、过滤器等等。大多数的 Linux 发行版里面都带有 OpenLDAP 的安装包。OpenLDAP 服务默认使用非加密的 TCP/IP 协议来接收服务的请求，并将查询结果传回到客户端。由于大多数目录服务都是用于系统的安全认证部分比如：用户登录和身份验证，所以它也支持使用基于 SSL/TLS 的加密协议来保证数据传送的保密性和完整性。OpenLDAP 是使用 OpenSSL 来实现 SSL/TLS 加密通信的。 

LDAP的信息模型是建立在"条目"（entries）的基础上。一个条目是一些属性的集合，并且具有一个全局唯一的"可区分名称"DN，一个条目可以通过DN来引用。每一个条目的属性具有一个类型和一个或者多个值。类型通常是容易记忆的名称，比如"cn"是通用名称（common name） ，或者"mail"是电子邮件地址。条目的值的语法取决于属性类型。比如，cn属性可能具有一个值"Babs Jensen" 。一个mail属性可能包含"bbs@kevin.com" 。一个jpegphoto属性可能包含一幅JPEG（二进制）格式的图片。



### LDAP` 常用关键字列表

> LDAP通过属性objectClass来控制哪一个属性必须出现或允许出现在一个条目中，它的值决定了该条目必须遵守的模式规则。

| 关键字 | 英文全称           | 含义                                                         |
| ------ | ------------------ | ------------------------------------------------------------ |
| dc     | Domain Component   | 域名的部分，其格式是将完整的域名分成几部分，如域名为example.com变成dc=example,dc=com |
| uid    | User Id            | 用户ID，如“tom”                                              |
| ou     | Organization Unit  | 组织单位，类似于Linux文件系统中的子目录，它是一个容器对象，组织单位可以包含其他各种对象（包括其他组织单元），如“market” |
| cn     | Common Name        | 公共名称，如“Thomas Johansson”                               |
| sn     | Surname            | 姓，如“Johansson”                                            |
| dn     | Distinguished Name | 惟一辨别名，类似于Linux文件系统中的绝对路径，每个对象都有一个惟一的名称，如“uid= tom,ou=market,dc=example,dc=com”，在一个目录树中DN总是惟一的 |
| rdn    | Relative dn        | 相对辨别名，类似于文件系统中的相对路径，它是与目录树结构无关的部分，如“uid=tom”或“cn= Thomas Johansson” |
| c      | Country            | 国家，如“CN”或“US”等。                                       |
| o      | Organization       | 组织名，如“Example, Inc.”                                    |



### LDAP`支持的目录操作

查询目录、更新目录、增加条目、删除条目、改变条目名称，搜索信息，最常用的LDAP操作是搜索信息操作。LDAP搜索操作允许搜索目录的一部分，查找匹配某个搜索过滤器规则的条目，搜索在 dc=example,dc=com 条目之中或者之下的整个目录子树，查找一个名字叫做 Barbara Jensen 的个人，并且获取每一个找到的条目的电子邮件地址。



#### LDAP协议简单介绍

目录是一组具有类似属性、以一定逻辑和层次组合的信息。常见的例子是通讯簿，由以字母顺序排列的名字、地址和电话号码组成。
目录服务是一种在分布式环境中发现目标的方法。目录具有两个主要组成部分：
第一部分是数据库，数据库是分布式的，且拥有一个描述数据的规划。
第二部分则是访问和处理数据的各种协议。

录服务其实也是一种数据库系统，只是这种数据库是一种树形结构，而不是通常使用的关系数据库。目录服务与关系数据库之间的主要区别在于：二者都允许对存储数据进行访问，只是目录主要用于读取，其查询的效率很高，而关系数据库则是为读写而设计的。
**温馨提示：目录服务不适于进行频繁的更新，属于典型的分布式结构。** 
LDAP是一个目录服务协议，目前存在众多版本的LDAP，而最常见的则是V2和V3两个版本，它们分别于1995年和1997年首次发布。



#### LDAP的基本模型

LDAP的基本模型是建立在"条目"（Entry）的基础上。一个条目是一个或多个属性的集合，并且具有一个全局唯一的"可区分名称"（用dn表示）。与关系型数据（后面简称数据库）进行类比，一个条目相当于数据库中的一条记录，而dn相当于数据库中记录的关键字，属性相当于数据库中的字段。
**温馨提示：dn必须是全局唯一的。** 
LDAP中，将数据组织成一个树形结构，这与现实生活中的很多数据结构可以对应起来，而不像设计关系型数据库的表，需要进行多种变化。如下图所展示的就是一个树形结构的数据。

![树形结构的数据](https://oss-md-pictures.oss-cn-hangzhou.aliyuncs.com/ldap%E5%8E%9F%E7%90%86%E5%9B%BE-1.jpg)

在上图所示的树形结构中，树的根结点是一个组织的域名（dlw.com），其下分为3个部分，分别是managers、people和group，可将这3个组看作组织中的3个部门：如managers用来管理所有管理人员，people用来管理登录系统的用户，group用来管理系统中的用户组。当然，在该图中还可继续增加其他分支。
对于图中所示的树形结构，使用关系数据库来保存数据的话，需要设置多个表，一层一层分别保存，当需要查找某个信息时，再逐层进行查询，最终得到结果。
若使用目录来保存该图中的数据，则更直观。图中每个结点用一个条目来保存，不同类型的结点需要保存的数据可能不同，在LDAP中通过一个称为objectClass的类型来控制不同结点需要的数据（称为属性）。

对于目录中的数据怎样进行引用呢？前面提到过，每一个条目都有一个dn，因为dn是唯一的，因此就可找到需要结点的数据。dn的构造方式如下：
首先得到条目自己的名称（rdn，称为相对dn），然后开始向上逐级查找父结点，一直到根项为止。例如，对于图1-1中最右下方的结点，其dn为：

```markdown
dn: cn=ldap, ou=group, o=dlw.com
```

通过这样的方式，即可唯一标识每一个结点。在现实生活中，有很多这种树形结构的数据，如计算机文件系统的目录结构、Internet中的域名等。这些类型的数据，只要不需要频繁的更新，都适合用目录来保存。

LDAP主要的简称含义：
**o**->   organization（组织-公司）
**ou**-> organization unit（组织单元-部门）
**c**->   countryName（国家）
**dc**-> domainComponent（域名）
**sn**-> suer name（真实名称）
**cn**-> common name（常用名称）



#### LDAP的功能

在LDAP的功能模型中定义了一系列利用LDAP协议的操作，主要包含以下4部分：
**查询操作**：允许查询目录和取得数据，其查询性能比关系数据库好。
**更新操作**：目录的更新操作没关系数据库方便，更新性能较差，但也同样允许进行添加、删除、修改等操作。
**复制操作**：前面也提到过，LDAP是一种典型的分布式结构，提供复制操作，可将主服务器的数据的更新复制到设置的从服务器中。
**认证和管理操作**：允许客户端在目录中识别自己，并且能够控制一个会话的性质。

**Ldap具体高级功能：**
实现账号统一集中管理；
权限控制策略管理；
密码控制策略管理；
密码审计管理；
主机控制管理；
同步机制管理；
TLS/SASL加密传输；
高可用负载均衡架构；
自定义schema；
各种集中平台账号集中管理；



#### LDAP协议的特点

LDAP是一种目录服务，保存在特殊的数据库中，数据的读取速度远高于写入速度。
LDAP对查询做了优化，读取速度优于普通关系数据库。
LDAP不支持事务、不能进行回滚，需要进行这些操作的应用只有选择关系数据库。
LDAP采用服务器/客户端模式，服务器端用于存储数据，客户端提供操作目录信息树的工具，支持分布式结构。
LDAP中的条目以树形结构组织和存储。
LDAP基于Internet协议，直接运行在简单和通用的TCP/IP或其他可靠的传输协议层上，使连接的建立和包的处理简单、快捷，对于互联网和企业网应用都很方便。
LDAP协议简单，通过使用查找操作实现列表操作和读操作。
LDAP通过引用机制实现分布式访问，通过客户端API实现分布式操作（对于应用透明），平衡了负载。
LDAP实现具有低费用、易配置和易管理的特点，并提供了满足应用程序对目录服务所需求的特性。



#### LDAP目录服务

目录是一个为查询、浏览和搜索而优化的专业分布式数据库，它呈树状结构组织数据，就好象Linux/Unix系统中的文件目录一样。目录数据库和关系数据库不同，它有优异的读性能，但写性能差，并且没有事务处理、回滚等复杂功能，不适于存储修改频繁的数据。所以目录天生是用来查询的，就好象它的名字一样。

目录服务是由目录数据库和一套访问协议组成的系统。类似以下的信息适合储存在目录中：

- 企业员工信息，如姓名、电话、邮箱等
- 公司的物理设备信息，如服务器，它的IP地址、存放位置、厂商、购买时间等
- 客户的联系信息
- 软件包的配置信息
- 公用证书和安全密匙

与LDAP一样提供类似的目录服务软件还有ApacheDS、Active Directory、Red Hat Directory Service 。



#### LDAP组织数据的方式

![LDAP组织数据的方式](https://oss-md-pictures.oss-cn-hangzhou.aliyuncs.com/open-ldap-2.png)





#### 身份认证在LDAP中提供三种认证机制

a）匿名认证：即不对用户进行认证，该方法仅对完全公开的方式适用
b）基本认证：通过用户名和密码进行身份识别，又分为简单密码和MD5密码认证
[root@ldap-server ~]# ldapadd -x -D "cn=root,dc=otas,dc=cn" -W -f base.ldif
Enter LDAP Password: 输入admin123
adding new entry "dc=otas,dc=cn"
adding new entry "ou=People,dc=otas,dc=cn"
adding new entry "ou=Group,dc=otas,dc=cn"
c）SASL认证：即LDAP提供的在SSL和TLS安全通道基础上进行的身份认证，包括数字证书的认证。



#### TLS安全性

分布式LDAP 是以明文的格式通过网络来发送信息的，包括client访问sldap的密码。TLS（SSL 的后继者，由OpenSSL 包）加密机制来解决这个问题。



##### LDAP目录数据结构

a）在LDAP中目录是按照树型结构组织——目录信息树（DIT），DIT是一个主要进行读操作的数据库
b）DIT由条目（Entry）组成，条目相当于关系数据库中表的记录；条目是具有分辨名DN（Distinguished Name）的属性-值对（Attribute-value,简称AV）的集合

在目录树中怎么组织数据 
cn=Fran Smith,ou=employees,dc=foobar,dc=com
               ------------ -----------------
                 容器条目    BaseDN
\--------------------------------------------
                 DN

->  在UNIX文件系统中，最顶层是根目录（root），LDAP目录也通常用ROOT做根，通常称为BaseDN。
->  因为历史（X.500）的原因，LDAP目录用OU（Organization Unit）从逻辑上把数据分开来。
Ou 也是一种条目，容器条目
->  Ou 下就是真正的用户条目

![](https://oss-md-pictures.oss-cn-hangzhou.aliyuncs.com/open-ldap-3.png)



##### 什么是dn?

dn即distinguished name的简称，在LDAP中，一个条目的分辨名叫做"dn"，dn是该条目在整个树中的唯一名称标识;dn相当于关系数据库表中的关键字（Primary Key）;dn是一个识别属性，通常用于检索

常见的两种dn设置：

```markdown
[root@ldap-server ~]# ldapsearch -x -LLL "uid=mac*"
dn: uid=mac,ou=People,dc=otas,dc=cn         唯一标适
uid: mac              
cn: mac
```

